<?php
/**
 * Copyright (c) 2024-2026. Volodymyr Hryvinskyi. All rights reserved.
 * Author: Volodymyr Hryvinskyi <volodymyr@hryvinskyi.com>
 * GitHub: https://github.com/hryvinskyi
 */

declare(strict_types=1);

use Hryvinskyi\EmailLogger\Block\Adminhtml\View;
use Magento\Framework\Escaper;

/** @var View $block */
/** @var Escaper $escaper */

$emailLog = $block->getLog();

if ($emailLog === null): ?>
    <div class="message message-error">
        <?= $escaper->escapeHtml(__('Email log not found.')) ?>
    </div>
<?php return;
endif;
?>

<style>
    .email-log-view {
        background: #ffffff;
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .email-log-view .email-header {
        border-bottom: 1px solid #e3e3e3;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    .email-log-view .email-header h2 {
        color: #4a3f39;
        margin: 0 0 10px 0;
        font-size: 18px;
    }
    .email-log-view .email-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .email-log-view .info-item {
        background: #f5f5f5;
        padding: 10px 15px;
        border-radius: 4px;
    }
    .email-log-view .info-item label {
        display: block;
        font-size: 12px;
        color: #666666;
        margin-bottom: 5px;
        text-transform: uppercase;
    }
    .email-log-view .info-item span {
        font-size: 14px;
        color: #4a3f39;
        font-weight: 500;
    }
    .email-log-view .email-details {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .email-log-view .email-details h3 {
        color: #4a3f39;
        margin: 0 0 15px 0;
        font-size: 14px;
        text-transform: uppercase;
    }
    .email-log-view .email-details table {
        width: 100%;
        border-collapse: collapse;
    }
    .email-log-view .email-details td {
        padding: 8px 10px;
        border-bottom: 1px solid #e3e3e3;
        font-size: 13px;
    }
    .email-log-view .email-details td:first-child {
        width: 150px;
        color: #666666;
        font-weight: 500;
    }
    .email-log-view .email-details td:last-child {
        color: #4a3f39;
        word-break: break-all;
    }
    .email-log-view .email-details tr:last-child td {
        border-bottom: none;
    }
    .email-log-view .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .email-log-view .status-success {
        background: #79a22e;
        color: #ffffff;
    }
    .email-log-view .status-error {
        background: #eb5202;
        color: #ffffff;
    }
    .email-log-view .status-pending {
        background: #fff1ad;
        color: #4a3f39;
    }
    .email-log-view .email-content {
        margin-bottom: 20px;
    }
    .email-log-view .email-content h3 {
        color: #4a3f39;
        margin: 0 0 15px 0;
        font-size: 14px;
        text-transform: uppercase;
    }
    .email-log-view .no-content-message {
        background: #fff1ad;
        padding: 15px;
        border-radius: 4px;
        color: #4a3f39;
        font-size: 14px;
    }
    .email-log-view .no-content-message a {
        color: #007dbd;
        text-decoration: underline;
    }
</style>

<div class="email-log-view">
    <div class="email-header">
        <h2><?= $escaper->escapeHtml($emailLog->getEmailSubject()) ?></h2>
        <?php
        $status = strtolower($emailLog->getSendingStatus());
        $statusClass = match (true) {
            str_contains($status, 'success') || str_contains($status, 'sent') => 'status-success',
            str_contains($status, 'error') || str_contains($status, 'fail') => 'status-error',
            default => 'status-pending'
        };
        ?>
        <span class="status-badge <?= $escaper->escapeHtmlAttr($statusClass) ?>">
            <?= $escaper->escapeHtml($emailLog->getSendingStatus()) ?>
        </span>
    </div>

    <div class="email-info">
        <div class="info-item">
            <label><?= $escaper->escapeHtml(__('ID')) ?></label>
            <span><?= (int)$emailLog->getLogEntryId() ?></span>
        </div>
        <div class="info-item">
            <label><?= $escaper->escapeHtml(__('Created At')) ?></label>
            <span><?= $escaper->escapeHtml($emailLog->getTimeOfSendingMail()) ?></span>
        </div>
        <div class="info-item">
            <label><?= $escaper->escapeHtml(__('Status')) ?></label>
            <span><?= $escaper->escapeHtml($emailLog->getSendingStatus()) ?></span>
        </div>
    </div>

    <div class="email-details">
        <h3><?= $escaper->escapeHtml(__('Email Details')) ?></h3>
        <table>
            <tr>
                <td><?= $escaper->escapeHtml(__('Sender')) ?></td>
                <td><?= $escaper->escapeHtml($emailLog->getEmailSender()) ?></td>
            </tr>
            <tr>
                <td><?= $escaper->escapeHtml(__('Recipient')) ?></td>
                <td><?= $escaper->escapeHtml($emailLog->getEmailRecipient()) ?></td>
            </tr>
            <tr>
                <td><?= $escaper->escapeHtml(__('Cc')) ?></td>
                <td><?= $escaper->escapeHtml($emailLog->getEmailCc() ?: '-') ?></td>
            </tr>
            <tr>
                <td><?= $escaper->escapeHtml(__('Bcc')) ?></td>
                <td><?= $escaper->escapeHtml($emailLog->getEmailBcc() ?: '-') ?></td>
            </tr>
            <tr>
                <td><?= $escaper->escapeHtml(__('Subject')) ?></td>
                <td><?= $escaper->escapeHtml($emailLog->getEmailSubject()) ?></td>
            </tr>
        </table>
    </div>

    <div class="email-content">
        <h3><?= $escaper->escapeHtml(__('Email Content')) ?></h3>
        <?php if ($emailLog->getEmailContent() === null): ?>
            <div class="no-content-message">
                <?= /* @noEscape */ __(
                    'During the recording of this log, the \'Save content\' option was disabled. You can enable it by clicking on %1.',
                    '<a href="' . $escaper->escapeUrl($block->getUrl('adminhtml/system_config/edit/section/emailslog')) . '">' . __('this link') . '</a>'
                ) ?>
            </div>
        <?php else: ?>
            <iframe loading="lazy"
                    width="100%"
                    height="700px"
                    style="border: 1px solid #e3e3e3; border-radius: 4px; background: #ffffff;"
                    src="<?= $escaper->escapeUrl($block->getUrl('hryvinskyi_email_log/index/viewlog', ['id' => $emailLog->getLogEntryId()])) ?>"></iframe>
        <?php endif; ?>
    </div>
</div>
